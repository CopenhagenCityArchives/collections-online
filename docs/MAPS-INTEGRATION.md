# KBH Billeder map interaction

## Integration
The main integration with the map is handled via [projects/collections-online/app/scripts-browserify/map.js](https://github.com/CopenhagenCityArchives/collections-online/blob/master/app/scripts-browserify/map.js). The module exports a Map object that exposes a number of properties that is sourced from a internal ```google.maps.Map``` instance.

## Instantiation
The map is loaded by the main controller for the search page [projects/collections-online/app/scripts-browserify/search/index.js](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/search/index.js#L357)

## Population
The map is updated by the search controllers  [updateMap function](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/search/index.js#L212). The function executes a search, using the map instances current state to [set a bounding box for the search](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/search/index.js#L216), wraps the search results in [coordinate objects](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/search/index.js#L263). If we're zoomed out wide enough to trigger hashing, [the center-coordinate for the hash is calculated](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/search/index.js#L277) and added to the coordinate object. The coordinates are then passed on to the controllers [update function](https://github.com/CopenhagenCityArchives/collections-online/blob/master/app/scripts-browserify/map.js#L105). The controller then clears the map of markers and populates it with markers. Markers can either be hash-markers (if we're zoomed out wide enough to trigger hashing), or actual asset markers. In the latter case [a popup](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/map.js#L134) is tied to the placemarker before it is added to the map.

## Refresh
If the map is manipulated (zoom or scroll), the map needs be refreshed. Before refreshing [the map is cleared](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/map.js#L298) to avoid confusion as the new markers are placed. The clearing is made as the user starts manipulating the map, and the refresh is triggered as the map [returns to idle](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/map.js#L316). The the refresh is performed by invoking a callback passed in as the controller [was initialized](https://github.com/CopenhagenCityArchives/collections-online/blob/7375642aceb725f9796cc982fde8ff2a2fd019e4/app/scripts-browserify/map.js#L251).
